---
title: "CRAN Downloads"
output: github_document
always_allow_html: true
---

```{r knit_opts, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  fig.path = "man/figures/README-",
  fig.width = 12,
  fig.height = 10
)
```

This repo contains the analysis of downloads of my `R` packages:

-   [`healthyR`](https://www.spsanderson.com/healthyR/)
-   [`healthyR.data`](https://www.spsanderson.com/healthyR.data/)
-   [`healthyR.ts`](https://www.spsanderson.com/healthyR.ts/)
-   [`healthyverse`](https://www.spsanderson.com/healthyverse/)

All of which follow the ["analyses as package"](https://rmflight.github.io/posts/2014/07/analyses_as_packages.html) philosophy this repo itself is an `R` package that can installed using `remotes::install_github()`.

I have forked this project itself from [`ggcharts-analysis`](https://github.com/thomas-neitmann/ggcharts-downloads).

While I analyze `healthyverse` packages here, the functions are written in a way that you can analyze any CRAN package with a slight modificaiton to the `download_log` function.

This file was last updated on `r format(Sys.Date(), "%B %d, %Y")`.

```{r setup, results='hide', echo=FALSE, message=FALSE, warning=FALSE}
library(packagedownloads)
library(ggplot2)
library(patchwork)
library(dplyr)
library(timetk)
library(purrr)
library(knitr)
```

```{r get_data, echo=FALSE, message=FALSE, warning=FALSE}
start_date      <- Sys.Date() - 9
end_date        <- Sys.Date() - 2
total_downloads <- download_logs(start_date, end_date)
interactive     <- FALSE
```

# Current Trend

Here are the current 7 day trends for the `healthyverse` suite of packages.

```{r analysis_7_day}
downloads            <- total_downloads[date >= start_date]
daily_downloads      <- compute_daily_downloads(downloads)
downloads_by_country <- compute_downloads_by_country(downloads)

p1 <- plot_daily_downloads(daily_downloads)
p2 <- plot_cumulative_downloads(daily_downloads)
p3 <- hist_daily_downloads(daily_downloads)
p4 <- plot_downloads_by_country(downloads_by_country)

f <- function(date) format(date, "%b %d, %Y")
patchwork_theme <- theme_classic(base_size = 24) +
  theme(
    plot.title = element_text(face = "bold"),
    plot.caption = element_text(size = 14)
  )
p1 + p2 + p3 + p4 +
  plot_annotation(
    title    = "healthyR packages are on the Rise",
    subtitle = "A Summary of Downloads from the RStudio CRAN Mirror - 7 Days",
    caption  = glue::glue("Source: RStudio CRAN Logs ({f(start_date)} to {f(end_date)})"),
    theme    = patchwork_theme
  )
```

# Since Inception

```{r total_data}
start_date <- as.Date("2020-11-15")

daily_downloads <- compute_daily_downloads(downloads = total_downloads)
downloads_by_country <- compute_downloads_by_country(downloads = total_downloads)

p1 <- plot_daily_downloads(daily_downloads)
p2 <- plot_cumulative_downloads(daily_downloads)
p3 <- hist_daily_downloads(daily_downloads)
p4 <- plot_downloads_by_country(downloads_by_country)

f <- function(date) format(date, "%b %d, %Y")
patchwork_theme <- theme_classic(base_size = 24) +
  theme(
    plot.title = element_text(face = "bold"),
    plot.caption = element_text(size = 14)
  )
p1 + p2 + p3 + p4 +
  plot_annotation(
    title    = "healthyR packages are on the Rise",
    subtitle = "A Summary of Downloads from the RStudio CRAN Mirror - Since Inception",
    caption  = glue::glue("Source: RStudio CRAN Logs ({f(start_date)} to {f(end_date)})"),
    theme    = patchwork_theme
  )
```

# Some table data

```{r top_n_data_tbl}
top_n_downloads(total_downloads, 10, r_os) %>%
  set_names("OS", "Count") %>%
  kable()

top_n_downloads(total_downloads, 10, r_version) %>%
  set_names("Version","Count") %>%
  kable()

top_n_downloads(total_downloads, 4, package) %>%
  set_names("Package","Count") %>%
  kable()
```

# Time Series Plot of each package

```{r time_series}
total_downloads %>%
  group_by(package) %>%
  summarise_by_time(
    .date_var = date
    , .by = "day"
    , count = dplyr::n()
  ) %>%
  plot_time_series(
    .date_var      = date
    , .value       = count
    , .color_var   = package
    , .facet_ncol  = 2
    , .title       = "Time Series Plot of Daily Downloads"
    , .interactive = interactive
  )
```

# Cumulative Downloads by Package
```{r cum_pkg_dl}
total_downloads %>% 
  tibble::as_tibble() %>% 
  select(date, package) %>% 
  group_by(package) %>% 
  summarise_by_time(.date_var = date, downloads = n()) %>% 
  ungroup() %>% 
  group_by(package) %>%
  mutate(cum_dl = cumsum(downloads)) %>% 
  ungroup() %>% 
  plot_time_series(
    .date_var = date
    , .value = cum_dl
    , .color_var = package
    , .smooth = FALSE
    , .interactive = FALSE
    , .line_size = 1
  )
```
